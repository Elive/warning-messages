#!/bin/bash
source /usr/lib/elive-tools/functions
#el_make_environment
. gettext.sh
TEXTDOMAIN="warning-messages"
export TEXTDOMAIN
el_check_translations_required_notify

WARN_DIR="$HOME/.cache/warning_messages"
cancel_ok_message="\n\n""$( eval_gettext "Click in No if you don't want to receive this notification again" )"
guitool=zenity

if [[ -z "$1" ]] ; then
    #echo -e "Usage: $(basename $0) message-type number-times-to-appear"
    echo -e "Usage: $(basename $0) message-type"
    exit 1
fi

if ! [[ -d "$WARN_DIR" ]] ; then
    mkdir -p "$WARN_DIR"
fi


#-------------------------------------------------------------------------------
#   Check control: show the message only if we need to show it
#-------------------------------------------------------------------------------
check_control(){
    # return true only if want need to show this message
    if [[ -f "${WARN_DIR}/${id}_${app}" ]] ; then
        return 1
    else
        return 0
    fi
}

#-------------------------------------------------------------------------------
#   Add control: if the user has press Cancel: create the file
#-------------------------------------------------------------------------------
add_control(){
    # file is created, the popup should not appear anymore
    touch "${WARN_DIR}/${id}_${app}"
}

#-------------------------------------------------------------------------------
#   Send message: send message and manage control
#-------------------------------------------------------------------------------
send_message(){
    # send message ($1 input), add the footer, and if the user click in Cancel then we dont show it anymore
    $guitool --question --text="$1""${cancel_ok_message}" || add_control "$id"
}


#-------------------------------------------------------------------------------
#   Message: Ecomorph
#-------------------------------------------------------------------------------
message_ecomorph(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Warning: If you use this feature you can have different types of problems like lost windows or bad positioning of windows, more instability in your desktop environment, windows that may disappear, windows that you can't click on, slow videos, etc. This feature is experimental and not finished. You are warned about what can happen and now you are welcome to use it." )" "$id"
}

#-------------------------------------------------------------------------------
#   Message: Suspend
#-------------------------------------------------------------------------------
message_suspend(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Warning: Suspend and hibernate features may give you problems like unresponsive hardware, specially when you are restoring, after which a reboot is required. Use these features with precaution! If your hardware doesn't correctly support the suspend feature, just do not use it." )" "$id"
}

#-------------------------------------------------------------------------------
#   Message: Compatibility of package not installed
#-------------------------------------------------------------------------------
message_compat_notinstalled(){
    check_control "$id" || exit 0

    local translated_message
    translated_message="$( printf "$( eval_gettext "Note: Your system has tried to use the application <b>%s</b>, but we will use instead an alternative, this is not bad at all, it makes your system much more compatible and integrated, in fact you don't need the original application at all, this message is only because we think that it is important for you to know this in the case that you really wanted to use that application specifically." )" "$@" )"

    send_message "$translated_message" "$id"
}
#-------------------------------------------------------------------------------
#   Message: NTFS crappy
#-------------------------------------------------------------------------------
message_ntfs_is_crap(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Warning: You are using a partition that is formatted in the Microsoft NTFS file system, for a fast usage it can work without problems, but if you want to continue using it other days is important that you know that it can be very unstable, it could totally block your computer or lose your data. The reason of these problems is because Microsoft changes the inner working of this file system without releasing any information so that other operating systems like Linux or Mac cannot be able to use it, this is because their system is not open source or because they use monopoly practices. This message is basically for tell you that if you experience problems, is the fault of Microsoft and not us, so do not report bugs to us. Finally, as a suggestion, if you want to have a stable file system to share data between different systems, please use FAT32 instead, it is a file system that works perfectly stable and any common operating system supports it." )" "$id"
}
#-------------------------------------------------------------------------------
#   Message: Super Mario War
#-------------------------------------------------------------------------------
message_supermariowar(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Unfortunately the original author of this really nice game (Florian Hufsky) doesn't live anymore, and so this beta version is not finished but works really well, if you are a programmer and want to revive this project you can search its existing community and source code in Google. We hope you enjoy of this amazing game." )" "$id"
    # Important: In order to run this beta game, an admin password will be requested in order to add write permissions to the map files for the games group.
}
#-------------------------------------------------------------------------------
#   Message: Super Mario War Permissions
#-------------------------------------------------------------------------------
message_supermariowarpermissions(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Important: To be able to edit the levels of this game, we need to give write permissions to the games group for this game directory, if security is important for you or this computer is used by more than one person, don't give the write permissions to this directory." )" "$id"
}

#-------------------------------------------------------------------------------
#   Message: Tell that using persistence results in lagged and slow system
#-------------------------------------------------------------------------------
message_persistence_is_slow(){
    check_control "$id" || exit 0
    send_message "$( eval_gettext "Due to layered filesystems, using persistence makes your experience much slower than not using it, if your desktop and system feels slow boot the non-persistence mode or even better, install Elive in your hard disk to unleash the full responsiveness and features." )" "$id"
}

#-------------------------------------------------------------------------------
#   MAIN
#-------------------------------------------------------------------------------
id="$1"
shift

app="$( echo "$1" | sed -e 's|^.*/||g' -e 's|\ .*||g' )"

case "$id" in
    compiz|ecomorph)
        message_ecomorph "$@"
        ;;
    hibernate|suspend|hebernate)
        message_suspend "$@"
        ;;
    compat_notinstalled)
        message_compat_notinstalled "$@"
        ;;
    ntfs_is_crap)
        message_ntfs_is_crap "$@"
        ;;
    supermariowar)
        message_supermariowar "$@"
        ;;
    supermariowarpermissions)
        message_supermariowarpermissions "$@"
        ;;
    persistence_is_slow)
        message_persistence_is_slow "$@"
        ;;
    *)
        el_explain 2 "not found any message mode to use called '$@' for $(basename $0)"
        ;;
esac

